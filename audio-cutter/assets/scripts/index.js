"use strict";import{Utils}from"/assets/scripts/utils.js?b6a1987596";const state={buffer:null,source:null,detail:null,animid:null,onplay:!1,hwidth:15,timeAt:0,timeOn:0,peaks:null},select={on:null,at:0,to:0},ofs={lHandle:0,rHandle:0},pos={lHandle:0,rHandle:0},UI={document:document.documentElement,fileBtn:Utils.Elem.$("#fileBtn"),saveBtn:Utils.Elem.$("#saveBtn"),playBtn:Utils.Elem.$("#playBtn"),stopBtn:Utils.Elem.$("#stopBtn"),overlay:Utils.Elem.$("#overlay"),lHandle:Utils.Elem.$("#lHandle"),rHandle:Utils.Elem.$("#rHandle"),lScreen:Utils.Elem.$("#lScreen"),rScreen:Utils.Elem.$("#rScreen"),detail:Utils.Elem.$(".detail"),parent:Utils.Elem.$(".parent"),canvas:Utils.Elem.$("canvas"),contxt:Utils.Elem.$("canvas").getContext("2d"),track:Utils.Elem.$(".track"),graph:Utils.Elem.$(".graph"),wave:"#808080",mask:"#fbbf24"},Status={el:Utils.Elem.$("#status-window"),pct:Utils.Elem.$("#floating-percent"),msg:Utils.Elem.$("#floating-infoMsg"),show(t){this.msg.innerText=t,this.pct.classList.remove("hidden"),this.el.classList.add("active")},update(t){this.pct.textContent=t+"%"},error(t){this.msg.innerText=t,this.pct.classList.add("hidden"),this.el.classList.add("active"),setTimeout(()=>this.hide(),5e3)},hide(){this.el.classList.remove("active")}},updateUIProgress=t=>{Utils.Elem.attr("#progress-percent","data-text",Math.round(t)+"%")},renderBuffer=async()=>state.buffer?state.buffer:null,animatePlayhead=()=>{if(!state.onplay)return;const t=state.timeAt+(Utils.audioContext.currentTime-state.timeOn),s=Math.min(select.at,select.to);t>=Math.max(select.at,select.to)?stopPlayback():(Utils.drawWaveForm(t/state.buffer.duration,state.peaks,UI,s/state.buffer.duration),UI.parent.dataset.time=Utils.FormatTime(t,!0),state.animid=requestAnimationFrame(animatePlayhead))},stopPlayback=()=>{if(state.source)try{state.source.stop(),state.source=null}catch(t){}cancelAnimationFrame(state.animid),state.animid=null,state.onplay=!1,Utils.drawWaveForm(0,state.peaks,UI),Utils.Elem.remClass(UI.playBtn,"hidden"),Utils.Elem.addClass(UI.stopBtn,"hidden")},startPlayback=async()=>{if(!state.buffer)return;if(state.onplay)return void stopPlayback();"suspended"===Utils.audioContext.state&&await Utils.audioContext.resume();const t=Math.min(select.at,select.to),s=Math.max(select.at,select.to);state.timeAt=t,state.timeOn=Utils.audioContext.currentTime,state.source=Utils.audioContext.createBufferSource(),state.source.buffer=state.buffer,state.source.connect(Utils.audioContext.destination),state.source.onended=()=>state.onplay&&stopPlayback(),state.source.start(0,t,s-t),state.onplay=!0,Utils.Elem.addClass(UI.playBtn,"hidden"),Utils.Elem.remClass(UI.stopBtn,"hidden"),animatePlayhead()},selTimes=()=>{const t=state.buffer.duration,s=UI.parent.getBoundingClientRect(),e=pos.lHandle+state.hwidth,a=pos.rHandle;select.at=e/s.width*t,select.to=a/s.width*t},initUI=()=>{ofs.lHandle=0,ofs.rHandle=0,pos.lHandle=-state.hwidth,pos.rHandle=UI.parent.offsetWidth,updateUI()},updateUI=()=>{const t=UI.parent.getBoundingClientRect();state.onplay&&stopPlayback(),UI.lHandle.style.left=pos.lHandle+"px",UI.rHandle.style.left=pos.rHandle+"px",selTimes(),Utils.Elem.text(UI.lScreen,Utils.FormatTime(select.at,!0)),Utils.Elem.text(UI.rScreen,Utils.FormatTime(select.to,!0));const updateLabel=(t,s,e)=>{const a=t.getBoundingClientRect(),l=s.getBoundingClientRect(),i=e.getBoundingClientRect();let o=l.left-a.left+l.width/2-i.width/2;o=Math.max(0,Math.min(o,a.width-i.width)),e.style.left=o+"px"};requestAnimationFrame(()=>{updateLabel(UI.parent,UI.lHandle,UI.lScreen),updateLabel(UI.parent,UI.rHandle,UI.rScreen)});const s=pos.lHandle+state.hwidth,e=pos.rHandle;if(e-s>0){const a=Math.max(0,s),l=Math.min(t.width,e);UI.overlay.style.display="block",UI.overlay.style.left=a+"px",UI.overlay.style.width=Math.max(0,l-a)+"px"}else UI.overlay.style.display="none"};Utils.Elem.on(UI.parent,"pointerdown",t=>{const s=UI.parent.getBoundingClientRect(),e=t.clientX-s.left;t.target.classList.contains("handle")?(select.on=t.target.id,ofs[select.on]=e-pos[select.on],t.target.setPointerCapture(t.pointerId)):t.target===UI.overlay&&(select.on="overlay",ofs.lHandle=e-pos.lHandle,ofs.rHandle=e-pos.rHandle,UI.overlay.setPointerCapture(t.pointerId))}),Utils.Elem.on(UI.parent,"pointermove",t=>{if(!select.on)return;const s=UI.parent.getBoundingClientRect(),e=t.clientX-s.left,a=-state.hwidth,l=UI.parent.offsetWidth;if("overlay"===select.on){const t=pos.rHandle-pos.lHandle;let s=e-ofs.lHandle,i=s+t;s<a?(s=a,i=s+t):i>l&&(i=l,s=i-t),pos.lHandle=s,pos.rHandle=i}else"lHandle"===select.on?pos.lHandle=Math.max(a,Math.min(e-ofs.lHandle,pos.rHandle-state.hwidth)):"rHandle"===select.on&&(pos.rHandle=Math.max(pos.lHandle+state.hwidth,Math.min(e-ofs.rHandle,l)));updateUI()}),Utils.Elem.on(window,"pointerup",()=>select.on=null),Utils.Elem.on(document,"click",async t=>{if(t.target.hasAttribute("data-button")){t.preventDefault(),t.stopPropagation();const s=t.target.dataset.button;if("fileBtn"===s){const s=Utils.Elem.cE("input",{type:"file"}),e=104857600,a=3599;state.onplay&&stopPlayback(),Utils.Elem.on(s,"input",async s=>{const l=s.target.files[0];if(Utils.audioContext&&l){if(l.size>e)return void Status.error("File too large. Maximum size: 100MB.");const s=await Utils.getAudioType(l);if(!s.type||!s.test)return void Status.error("Not supported file format!");Utils.Elem.addClass(UI.track,"hidden"),Utils.Elem.addClass(t.target,"disabled");let i=await Utils.decodeAudio(l);if(i.duration>a)return Status.error("Audio too long. Maximum length: 20 minutes."),void Utils.Elem.remClass(t.target,"disabled");select.at=0,select.to=i.duration,UI.parent.dataset.time=Utils.FormatTime(i.duration,!0),state.buffer=i,state.detail=l.name,Utils.Elem.text(UI.detail,state.detail),Utils.Elem.remClass(t.target,"disabled"),state.peaks=Utils.extractPeaks(i,UI),Utils.drawWaveForm(0,state.peaks,UI),Utils.Elem.remClass(UI.track,"hidden"),initUI()}}),s.click()}else if("playBtn"===s)state.onplay?stopPlayback():startPlayback();else if("saveCutted"===s){if(0===select.at&&select.to===state.buffer.duration)return;if(select.to-select.at>0&&state.buffer){Status.update(0),Status.show("Export cutted audio to file...");const t=Math.floor(select.at*state.buffer.sampleRate),s=Math.floor(select.to*state.buffer.sampleRate),e=Math.floor(.005*state.buffer.sampleRate),a=Utils.audioContext.createBuffer(state.buffer.numberOfChannels,state.buffer.length-(s-t),state.buffer.sampleRate);for(let l=0;l<state.buffer.numberOfChannels;l++){const i=state.buffer.getChannelData(l),o=a.getChannelData(l);o.set(i.subarray(0,t));for(let s=0;s<e;s++){const a=t-e+s;if(a>=0){const t=1-s/e;o[a]*=t}}o.set(i.subarray(s),t);for(let s=0;s<e;s++){const a=t+s;if(a<o.length){const t=s/e;o[a]*=t}}}const l=await Utils.MP3encode(a,t=>Status.update(t));Utils.saveFile(l,Utils.getFileName(state.detail,"cutted_",".mp3")),Status.hide()}}else if("saveTrimmed"===s){if(select.to-select.at>0&&state.buffer){Status.update(0),Status.show("Export trimmed audio to file...");const t=Math.floor(select.at*state.buffer.sampleRate),s=Math.floor(select.to*state.buffer.sampleRate),e=Utils.audioContext.createBuffer(state.buffer.numberOfChannels,s-t,state.buffer.sampleRate);for(let a=0;a<state.buffer.numberOfChannels;a++){const l=state.buffer.getChannelData(a);e.getChannelData(a).set(l.subarray(t,s))}const a=await Utils.MP3encode(e,t=>Status.update(t));Utils.saveFile(a,Utils.getFileName(state.detail,"trimmed_",".mp3")),Status.hide()}}else"menuToggle"===s&&t.target.nextElementSibling.classList.toggle("visible")}}),Utils.Elem.on(window,"load",async()=>{if(!Cookies.get("consent")){const t=Utils.Elem.cE("div",{class:"cookie-bar"}),s=Utils.Elem.cE("div",{class:"cookie-content"}),e=Utils.Elem.cE("div",{class:"cookie-actions"}),a=Utils.Elem.cE("p"),l=Utils.Elem.cE("a",{class:"btn btn-primary",href:"#"}),i=Utils.Elem.cE("a",{class:"btn btn-secondary",href:"/cookies/"});l.textContent="Accept",i.textContent="Settings",a.textContent="We use cookies to enhance your browsing experience and personalize content. By continuing to use our site, you agree to our use of cookies.",e.appendChild(l),e.appendChild(i),s.appendChild(a),t.appendChild(s),t.appendChild(e),document.body.appendChild(t),Utils.Elem.on(l,"click",s=>{s.preventDefault(),s.stopPropagation(),Cookies.set("consent","created",{expires:7,path:"/"}),document.body.removeChild(t)})}});const resizeObserver=new ResizeObserver(t=>{for(let s of t){const{width:t}=s.contentRect;state.buffer&&state.peaks&&(state.peaks=Utils.extractPeaks(state.buffer,UI),Utils.drawWaveForm(0,state.peaks,UI))}});resizeObserver.observe(UI.parent);