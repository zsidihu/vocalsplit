"use strict";export const Config={sampleRate:48e3};export const Utils={audioContext:new(window.AudioContext||window.webkitAudioContext)({sampleRate:Config.sampleRate,latencyHint:"playback"}),supportFlags:{hasSimd:!1,hasBulk:!1},svgElements:["rect","circle","ellipse","line","polyline","polygon","path","text","tspan","textPath","svg","g","defs","use","symbol","style","clipPath","mask","filter","pattern","linearGradient","radialGradient","title","desc","image","animateTransform"],Elem:{$:t=>document.querySelector(t),$$:t=>document.querySelectorAll(t),cE(t,e={}){const n=Utils.svgElements.includes(t)?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);for(const[t,a]of Object.entries(e))null!=a&&n.setAttribute(t,a);return n},addClass:(t,...e)=>(t instanceof Element?t:Utils.Elem.$(t))?.classList.add(...e),remClass:(t,...e)=>(t instanceof Element?t:Utils.Elem.$(t))?.classList.remove(...e),attr(t,e,n){const a=t instanceof Element?t:this.$(t);if(a)return void 0===n?a.getAttribute(e):void a.setAttribute(e,n)},text(t,e){const n=t instanceof Element?t:this.$(t);if(n)return void 0===e?n.textContent:void(n.textContent=e)},on:(t,e,n,a)=>{const s=t instanceof Element||t instanceof Document||t===window?t:Utils.Elem.$(t);s?.addEventListener(e,n,a)},off:(t,e,n,a)=>{const s=t instanceof Element||t instanceof Document||t===window?t:Utils.Elem.$(t);s?.removeEventListener(e,n,a)}},WorkerObject:null,GetWorkerScript:async()=>{if(!Utils.WorkerObject){const t=await fetch("https://assets.vocalsplit.app/MP3Decoder.min.js?b6a1987596"),e=await t.blob();Utils.WorkerObject=URL.createObjectURL(e)}return Utils.WorkerObject},WasmDetect:{validate:t=>WebAssembly.validate(new Uint8Array(t)),simd:async()=>Utils.WasmDetect.validate([0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11]),bulkMemory:async()=>Utils.WasmDetect.validate([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,3,1,0,1,10,14,1,12,0,65,0,65,0,65,0,252,10,0,0,11]),threads:async()=>{try{return"undefined"!=typeof MessageChannel&&((new MessageChannel).port1.postMessage(new SharedArrayBuffer(1)),Utils.WasmDetect.validate([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,2,1,0,5,4,1,3,1,1,10,11,1,9,0,65,0,254,16,2,0,26,11]))}catch(t){return!1}}},SelectBox:(t,e)=>{const n=Utils.Elem.$(t),a=n.firstElementChild,s=n.lastElementChild;let o=n.dataset.value||null;Utils.Elem.on(a,"click",t=>{t.stopPropagation(),n.classList.toggle("open")}),Array.from(s.children).forEach(t=>{Utils.Elem.on(t,"click",s=>{s.stopPropagation();const i=t.dataset.value,r=t.textContent;i!==o?(o=i,a.dataset.value=i,Utils.Elem.text(a,r),Utils.Elem.remClass(n,"open"),"function"==typeof e&&e(i,r,a)):Utils.Elem.remClass(n,"open")})}),Utils.Elem.on(document,"click",()=>Utils.Elem.remClass(n,"open"))},clamp:(t,e,n)=>Math.max(e,Math.min(n,t)),getFileName:(t,e="",n="")=>{const a=t.lastIndexOf(".");return a<=0?e+t+n:e+t.slice(0,a)+n},saveFile:(t,e)=>{const n=URL.createObjectURL(t),a=Utils.Elem.cE("a",{download:e,href:n,style:"display: none"});document.body.appendChild(a),a.click(),document.body.removeChild(a),setTimeout(()=>URL.revokeObjectURL(n),100)},drawWaveForm:(t=0,e,n,a=0)=>{if(0===e.length)return;const drawBars=(t,e,n)=>{const a=e.canvas.width/t.length;e.contxt.fillStyle=n,t.forEach((t,n)=>{const s=n*a,o=(e.canvas.height-t)/2;e.contxt.fillRect(s+1,o,a-2,t)})};n.contxt.clearRect(0,0,n.canvas.width,n.canvas.height),drawBars(e,n,n.wave),n.contxt.save(),n.contxt.beginPath();const s=n.canvas.width*a,o=n.canvas.width*t-s;n.contxt.rect(s,0,o,n.canvas.height),n.contxt.clip(),drawBars(e,n,n.mask),n.contxt.restore()},extractPeaks:(t,e)=>{e.canvas.width=e.parent.clientWidth,e.canvas.height=e.parent.clientHeight;const n=t.getChannelData(0),a=Math.floor(e.canvas.width/4),s=Math.floor(n.length/a),o=[];for(let t=0;t<a;t++){let a=0;for(let e=0;e<s;e++){const o=Math.abs(n[t*s+e]);o>a&&(a=o)}o.push(a*e.canvas.height*.6)}return o},Attach:(t,e)=>{for(let n in e)t.appendChild(e[n])},GetElapsed:(t,e)=>{if(!e)return 0;const n=Utils.audioContext.currentTime,a=n-t.timing.current;return t.timing.current=n,t.timing.elapsed+=a*e.playbackRate.value,t.timing.elapsed},FormatTime:(t,e=!1)=>{const n=Math.floor(t),a=Math.floor(t%1*1e3),s=Math.floor(n%3600/60),o=n%60;return e?s.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")+"."+a.toString()[0]:s.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")},getRangeThumb:t=>{const e=parseFloat(t.min)||0,n=parseFloat(t.max)||100;return(parseFloat(t.value)-e)/(n-e)*(t.offsetWidth-20)+10},getAudioType:async t=>{if(!t)return{type:null,test:!1};const e=new Uint8Array(await t.slice(0,131072).arrayBuffer()),checkStr=(t,e,n)=>{for(let a=0;a<n.length;a++)if(t[e+a]!==n.charCodeAt(a))return!1;return!0};let n=null,a="";if(checkStr(e,0,"RIFF")&&checkStr(e,8,"WAVE"))n="wav",a="audio/wav";else if(checkStr(e,0,"fLaC"))n="flac",a="audio/flac";else if(checkStr(e,0,"OggS"))n="ogg",a="audio/ogg";else if(checkStr(e,4,"ftyp"))n="m4a",a="audio/mp4";else if(checkStr(e,0,"ID3"))n="mp3",a="audio/mpeg";else{let t=0;73===e[0]&&68===e[1]&&51===e[2]&&(t=(127&e[6])<<21|(127&e[7])<<14|(127&e[8])<<7|127&e[9],t+=10);const s=Math.min(t+16384,e.length-10);for(let o=t;o<s;o++)if(255===e[o]&&!(224&~e[o+1])){const t=e[o+1],s=t>>3&3,i=t>>1&3,r=e[o+2],l=r>>4,c=r>>2&3;if(1!==s&&0!==i&&l>0&&l<15&&3!==c){const t=1e3*[0,32,40,48,56,64,80,96,112,128,160,192,224,256,320][l],s=[44100,48e3,32e3][c],i=r>>1&1,f=Math.floor(144*t/s)+i;if(o+f<e.length&&255===e[o+f]){n="mp3",a="audio/mpeg";break}}}}if(n){const t=document.createElement("audio").canPlayType(a);return{type:n,test:"probably"===t||"maybe"===t}}return{type:null,test:!1}},PerformanceTracker:{formatBytes:(t,e=2)=>{if(0===t)return"0 Bytes";const n=e<0?0:e,a=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,a)).toFixed(n))+" "+["Bytes","KB","MB","GB"][a]},calculate:(t,e,n)=>{const a=(performance.now()-t)/1e3,s=e.reduce((t,e)=>t+(e.file?e.file.size:0),0),o=n.length*n.numberOfChannels*4,i=(n.duration/a).toFixed(1);return{time:a.toFixed(2)+"s",source:Utils.PerformanceTracker.formatBytes(s),pcm:Utils.PerformanceTracker.formatBytes(o),speed:i+"x"}}},ResampleBuffer:async(t,e)=>{if(t.sampleRate===e)return t;const n=new OfflineAudioContext(t.numberOfChannels,Math.ceil(t.duration*e),e),a=n.createBufferSource();return a.buffer=t,a.connect(n.destination),a.start(0),await n.startRendering()},decodeAudio:async(t,e)=>{const n=await t.arrayBuffer(),a=n.slice(0);try{const t=await Utils.audioContext.decodeAudioData(n);return await Utils.ResampleBuffer(t,Config.sampleRate)}catch(t){return"mp3"!==e?null:new Promise(async(t,e)=>{try{const n=await Utils.GetWorkerScript(),s=new Worker(n);s.onmessage=async n=>{const a=n.data;if(!a||!a.channelData)return s.terminate(),void e(new Error("Worker decoding failed"));const o=Utils.audioContext.createBuffer(a.channelData.length,a.channelData[0].length,a.sampleRate);for(let t=0;t<a.channelData.length;t++)o.getChannelData(t).set(a.channelData[t]);const i=await Utils.ResampleBuffer(o,Config.sampleRate);s.terminate(),t(i)},s.onerror=t=>{s.terminate(),e(null)},s.postMessage(a,[a])}catch(t){e(null)}})}},GetBlobUrl:async t=>{const e=await fetch(t);if(!e.ok)return null;const n=await e.text();return URL.createObjectURL(new Blob([n],{type:"application/javascript"}))},WAVEncode:async(t,e)=>{const n=t.numberOfChannels,a=t.sampleRate,s=2*n,o=t.length,i=o*s,r=new ArrayBuffer(44+i),l=new DataView(r),writeString=(t,e)=>{for(let n=0;n<e.length;n++)l.setUint8(t+n,e.charCodeAt(n))};writeString(0,"RIFF"),l.setUint32(4,36+i,!0),writeString(8,"WAVE"),writeString(12,"fmt "),l.setUint32(16,16,!0),l.setUint16(20,1,!0),l.setUint16(22,n,!0),l.setUint32(24,a,!0),l.setUint32(28,a*s,!0),l.setUint16(32,s,!0),l.setUint16(34,16,!0),writeString(36,"data"),l.setUint32(40,i,!0);let c=44,f=0;return new Promise(a=>{const processChunk=()=>{const s=Math.min(f+65536,o);for(;f<s;f++)for(let e=0;e<n;e++){let n=t.getChannelData(e)[f];n=Math.max(-1,Math.min(1,n)),l.setInt16(c,n<0?32768*n:32767*n,!0),c+=2}e&&e(Math.round(f/o*100)),f<o?setTimeout(processChunk,0):a(new Blob([r],{type:"audio/wav"}))};processChunk()})},MP3encode:async(t,e,n=128)=>{const a=Math.min(navigator.hardwareConcurrency||4,4),s=Math.ceil(t.length/a),o=t.sampleRate,i=Utils.supportFlags.hasSimd?"https://assets.vocalsplit.app/Mp3LameEncoder.simd.js?b6a1987596":"https://assets.vocalsplit.app/Mp3LameEncoder.js?b6a1987596",r=await fetch(i),l=await r.blob(),c=URL.createObjectURL(l),f=new Array(a).fill(0),u={V1L3:[null,32,40,48,56,64,80,96,112,128,160,192,224,256,320,null],V2L3:[null,8,16,24,32,40,48,56,64,80,96,112,128,144,160,null]},p={V1:[44100,48e3,32e3,null],V2:[22050,24e3,16e3,null],V25:[11025,12e3,8e3,null]},d=await Promise.all(Array.from({length:a},(i,r)=>{return l=r,new Promise((i,r)=>{const u=0===l,p=l===a-1,d=l*s,m=Math.min(d+s,t.length),h=u?d:Math.max(0,d-2304),w=p?m:Math.min(t.length,m+2304),y=new Worker(URL.createObjectURL(new Blob([`self.Mp3LameEncoderConfig={locateFile:()=>"",onRuntimeInitialized:()=>self.postMessage({text:"ready"})},importScripts("${c}");let encoder=null;self.onmessage=a=>{const{text:b,data:c}=a.data;if("init"===b)encoder=new Mp3LameEncoder(c.sr,c.br),self.postMessage({text:"next"});else if("encode"===b)encoder.encode(c),self.postMessage({text:"next"});else if("finish"===b){const a=encoder.finish();a.arrayBuffer().then(a=>{self.postMessage({text:"complete",buffer:a},[a])})}};`],{type:"application/javascript"})));let g=h;y.onmessage=s=>{const{text:r,buffer:c}=s.data;if("ready"===r)y.postMessage({text:"init",data:{sr:o,br:n}});else if("next"===r)if(g<w){const n=Math.min(g+131072,w),s=new Float32Array(t.getChannelData(0).subarray(g,n)),o=t.numberOfChannels>1?new Float32Array(t.getChannelData(1).subarray(g,n)):new Float32Array(s.length);y.postMessage({text:"encode",data:[s,o]},[s.buffer,o.buffer]),g=n,f[l]=(g-h)/(w-h)*100,e&&e(Math.round(f.reduce((t,e)=>t+e,0)/a))}else y.postMessage({text:"finish"});else"complete"===r&&(y.terminate(),i({buffer:c,logicalAt:d-h,logicalTo:m-h}))},y.onerror=t=>{y.terminate(),r(t)}});var l})),m=[];return d.forEach((t,e)=>{const n=new Uint8Array(t.buffer),a=(t=>{const e=[];let n=0,a=0;for(;n+4<=t.length;){const s=t[n],o=t[n+1],i=t[n+2];if(t[n+3],255!==s||224&~o){n++;continue}const r=o>>3&3;if(1===r||1!=(o>>1&3)){n++;continue}const l=i>>4&15,c=i>>2&3,f=i>>1&1;if(15===l||0===l||3===c){n++;continue}let d;d=3===r?"V1":2===r?"V2":"V25";const m=("V1"===d?u.V1L3:u.V2L3)[l],h=p[d][c];if(!m||!h){n++;continue}const w="V1"===d?1152:576,y="V1"===d?Math.floor(144e3*m/h)+f:Math.floor(72e3*m/h)+f;y<=0||n+y>t.length?n++:(e.push({byteOffset:n,byteLength:y,pcmStart:a,pcmEnd:a+w}),a+=w,n+=y)}return e})(n);if(0===a.length)return;const s=t.logicalAt,o=t.logicalTo;let i=-1,r=-1;for(let t=0;t<a.length;t++){const e=a[t];if(!(e.pcmEnd<=s)){if(e.pcmStart>=o)break;-1===i&&(i=t),r=t}}if(-1===i||-1===r)return;const l=a[i],c=a[r],f=l.byteOffset,d=c.byteOffset+c.byteLength;m.push(n.subarray(f,d))}),URL.revokeObjectURL(c),new Blob(m,{type:"audio/mpeg"})},OGGEncode:async(t,e,n=.5)=>{const a=t.sampleRate,s=t.numberOfChannels,o=Utils.supportFlags.hasSimd?"https://assets.vocalsplit.app/OggVorbisEncoder.simd.js?b6a1987596":"https://assets.vocalsplit.app/OggVorbisEncoder.js?b6a1987596",i=new Worker(URL.createObjectURL(new Blob([`self.OggVorbisEncoderConfig={locateFile:()=>"",onRuntimeInitialized:()=>self.postMessage({text:"ready"})},importScripts("${o}");let encoder=null;self.onmessage=a=>{const{text:b,data:c}=a.data;if("init"===b)encoder=new self.OggVorbisEncoder(c.sr,c.ch,c.q),self.postMessage({text:"next"});else if("encode"===b)encoder.encode(c),self.postMessage({text:"next"});else if("finish"===b){const a=encoder.finish();a.arrayBuffer().then(a=>{self.postMessage({text:"complete",buffer:a},[a])})}};`],{type:"application/javascript"})));let r=0,l=0;const c=new Promise((o,c)=>{i.onmessage=c=>{const{text:f,buffer:u}=c.data;if("ready"===f)i.postMessage({text:"init",data:{sr:a,ch:s,q:n}});else if("next"===f)if(r<t.length){const n=Math.min(r+131072,t.length),a=Array.from({length:s},(e,a)=>t.getChannelData(a).slice(r,n));i.postMessage({text:"encode",data:a},a.map(t=>t.buffer)),r=n,l++,e&&e(Math.round(l/Math.ceil(t.length/131072)*100))}else i.postMessage({text:"finish"});else"complete"===f&&(i.terminate(),o(u))},i.onerror=t=>{i.terminate(),c(t)}}),f=await c;return new Blob([f],{type:"audio/ogg"})},SleepMS:t=>new Promise(e=>setTimeout(e,t))};Utils.Elem.on(window,"load",async()=>{Utils.supportFlags.hasSimd=await Utils.WasmDetect.simd(),Utils.supportFlags.hasBulk=await Utils.WasmDetect.bulkMemory()});